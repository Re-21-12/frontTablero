<div class="wrap">
  <h2>Emails</h2>

  <div class="panel">
    <label>Filtrar por estado:</label>
    <select [(ngModel)]="filterStatusValue">
      <option value="">(todos)</option>
      <option value="queued">queued</option>
      <option value="sent">sent</option>
      <option value="failed">failed</option>
    </select>
    <button (click)="refresh()">Actualizar</button>
  </div>

  <div class="msgs" *ngIf="msg() || err()">
    <p class="ok" *ngIf="msg()">{{ msg() }}</p>
    <p class="bad" *ngIf="err()">{{ err() }}</p>
  </div>

  <div class="grid">
    <div class="col">
      <h3>Formulario</h3>
      <div class="tabs">
        <button [class.active]="mode() === 'send'" (click)="mode.set('send')">Enviar</button>
        <button [class.active]="mode() === 'draft'" (click)="mode.set('draft')">Borrador</button>
        <button [class.active]="mode() === 'edit-draft'" disabled *ngIf="mode() === 'edit-draft'">
          Editando borrador #{{ editingId() }}
        </button>
      </div>

      <form (ngSubmit)="mode()==='send' ? send() : mode()==='draft' ? saveDraft() : updateDraft()">
        <label>Para</label>
        <input type="email" [(ngModel)]="to" name="to" required />

        <label>Asunto</label>
        <input type="text" [(ngModel)]="subject" name="subject" required />

        <label>Cuerpo (HTML permitido)</label>
        <textarea rows="8" [(ngModel)]="body" name="body" required></textarea>

        <div class="actions">
          <button type="submit" *ngIf="mode()==='send'">Enviar ahora</button>
          <button type="submit" *ngIf="mode()==='draft'">Guardar borrador</button>
          <button type="submit" *ngIf="mode()==='edit-draft'">Guardar cambios</button>
          <button type="button" (click)="clearForm()">Limpiar</button>
        </div>
      </form>
    </div>

    <div class="col">
      <h3>Listado</h3>
      <div *ngIf="loading()">Cargando...</div>
      <table *ngIf="!loading()">
        <thead>
          <tr>
            <th>Id</th>
            <th>Para</th>
            <th>Asunto</th>
            <th>Estado</th>
            <th>Creado</th>
            <th>Enviado</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let e of emails()">
            <td>{{ e.id }}</td>
            <td>{{ e.to }}</td>
            <td>{{ e.subject }}</td>
            <td>
              <span [class.bad]="e.status==='failed'"
                    [class.warn]="e.status==='queued'"
                    [class.ok]="e.status==='sent'">
                {{ e.status }}
              </span>
            </td>
            <td>{{ e.createdAt | date:'short' }}</td>
            <td>{{ e.sentAt ? (e.sentAt | date:'short') : '-' }}</td>
            <td class="row-actions">
              <button (click)="editDraft(e)" [disabled]="e.status!=='queued'">Editar</button>
              <button (click)="remove(e)">Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
